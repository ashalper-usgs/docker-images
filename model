#! /bin/sh
#
# U.S. Geological Survey
#
# File - model
#
# Purpose - NHM container entry-point script.
#
# Author - Andrew Halper <ashalper@usgs.gov>
#

# if the HRU data is not on the volume yet ...
if [ ! -e /nhm/gridmetetl/nhm_hru_data_gfv11 ]; then
    echo "downloading HRU data ..."
    cd /nhm/gridmetetl
    wget --progress=bar:noscroll --waitretry=3 --retry-connrefused \
	 ${HRU_SOURCE?"not defined"}
    unzip -o ${HRU_DATA_PKG?"not defined"}
    rm $HRU_DATA_PKG
fi

# if the PRMS data is not on the volume yet ...
if [ ! -e /nhm/NHM-PRMS_CONUS_GF_1_1 ]; then
  # ... download it
  echo "downloading PRMS data ..."
  cd /nhm
  wget --progress=bar:noscroll --waitretry=3 --retry-connrefused \
       ${PRMS_SOURCE?"not defined"}
  unzip -o ${PRMS_DATA_PKG?"not defined"}
  rm $PRMS_DATA_PKG
fi

# start date is the base name of the last restart file
RESTART_DATE=`cd /nhm/NHM-PRMS_CONUS_GF_1_1/restart && \
	      ls -1 *.restart | sort | tail -1 | cut -f1 -d .`

# end date is yesterday
yesterday=`date --date yesterday --rfc-3339='date'`

# if END_DATE is not set already
if [ -z "$END_DATE" ]; then
    END_DATE=$yesterday
fi

# if START_DATE is not set already
if [ -z "$START_DATE" ]; then
    START_DATE=`date --date "$RESTART_DATE +1 day" --rfc-3339='date'`
fi

if [ -z "$SAVE_RESTART_DATE" ]; then
    SAVE_RESTART_DATE=`date --date "$yesterday -59 days" --rfc-3339='date'`
fi

# if we want to run gridMET ...
if [ "$GRIDMET_DISABLE" != true ]; then
  # TODO: version number is hard-coded in path here
  /opt/conda/bin/python -u \
     ${SOURCE_DIR?"not defined"}/gridmetetl/gridmetetl/Gridmet_current.py 
fi

/opt/conda/bin/python \
  -u $SOURCE_DIR/gridmetetl/gridmetetl/gridmet_etl.py \
  -t date -p $START_DATE $END_DATE \
  -i /nhm/gridmetetl/nhm_hru_data_gfv11 \
  -o ${CBH_IDIR?"not defined"} \
  -w /nhm/gridmetetl/nhm_hru_data_gfv11/tmp_Gridmet_weights_hru_v1_1e.csv \
  --partial=true
