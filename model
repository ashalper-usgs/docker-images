#! /bin/sh
#
# U.S. Geological Survey
#
# File - model
#
# Purpose - NHM container entry-point script.
#
# Author - Andrew Halper <ashalper@usgs.gov>
#

# if the HRU data is not on the volume yet ...
if [ ! -e /nhm/gridmetetl/nhm_hru_data_gfv11 ]; then
    echo "downloading HRU data ..."
    cd /nhm/gridmetetl
    wget --progress=bar:noscroll --waitretry=3 --retry-connrefused \
	 ${HRU_SOURCE?"not defined"}
    unzip -o ${HRU_DATA_PKG?"not defined"}
    rm $HRU_DATA_PKG
fi

# if the PRMS data is not on the volume yet ...
if [ ! -e /nhm/NHM-PRMS_CONUS_GF_1_1 ]; then
  # ... download it
  echo "downloading PRMS data ..."
  cd /nhm
  wget --progress=bar:noscroll --waitretry=3 --retry-connrefused \
       ${PRMS_SOURCE?"not defined"}
  unzip -o ${PRMS_DATA_PKG?"not defined"}
  rm $PRMS_DATA_PKG
fi

# start date is the base name of the last restart file
RESTART_DATE=`cd /nhm/NHM-PRMS_CONUS_GF_1_1/restart && \
	      ls -1 *.restart | sort | tail -1 | cut -f1 -d .`

# end date is yesterday
yesterday=`date --date yesterday --rfc-3339='date'`

# if END_DATE is not set already
if [ -z "$END_DATE" ]; then
    END_DATE=$yesterday
fi

# if START_DATE is not set already
if [ -z "$START_DATE" ]; then
    START_DATE=`date --date "$RESTART_DATE +1 day" --rfc-3339='date'`
fi

# if we want to run gridMET ...
if [ "$GRIDMET_DISABLE" != true ]; then
  # TODO: version number is hard-coded in path here
  /opt/conda/bin/python -u \
     ${SOURCE_DIR?"not defined"}/gridmetetl/gridmetetl/Gridmet_current.py 
fi

# gridMETETL
/opt/conda/bin/python \
  -u $SOURCE_DIR/gridmetetl/gridmetetl/gridmet_etl.py \
  -t date -p $START_DATE $END_DATE \
  -i /nhm/gridmetetl/nhm_hru_data_gfv11 \
  -o ${CBH_IDIR?"not defined"} \
  -w /nhm/gridmetetl/nhm_hru_data_gfv11/tmp_Gridmet_weights_hru_v1_1e.csv \
  --partial=true

# ncf2cbh
/opt/conda/bin/python -u \
  $SOURCE_DIR/onhm-runners/ncf2cbh/ncf2cbh_gfv11.py \
  /nhm/NHM-PRMS_CONUS_GF_1_1/input/

# cbhfiller
/opt/conda/bin/python -u \
  $SOURCE_DIR/onhm-runners/cbh_filler/cbh_filler.py \
  ${CBH_IDIR?"not defined"} $CBH_IDIR \
  $SOURCE_DIR/onhm-runners/cbh_filler/nhm_id.txt \
  $SOURCE_DIR/onhm-runners/cbh_filler/miss_to_pres_mapping.csv

# PRMS

# start time is $START_DATE in PRMS start_date datetime format
START_TIME=`date --date $START_DATE +%Y,%m,%d,00,00,00`
# end time is start date + 1 day in PRMS end_date datetime format
END_TIME=`date --date $END_DATE +%Y,%m,%d,00,00,00`

# PRMS needs to be run in a directory relative to its data files (in
# subdirectories)
cd /nhm/NHM-PRMS_CONUS_GF_1_1

$SOURCE_DIR/prms/prms/prms \
  -set start_time $START_TIME -set end_time $END_TIME \
  -set init_vars_from_file 1 \
  -set var_init_file /nhm/NHM-PRMS_CONUS_GF_1_1/restart/$RESTART_DATE.restart \
  -set save_vars_to_file 0 \
  -set var_save_file ${VAR_SAVE_FILE?"not defined"} \
  -C /nhm/NHM-PRMS_CONUS_GF_1_1/NHM-PRMS.control

# out2ncf
/opt/conda/bin/python -u \
  /usr/local/src/onhm-runners/out2ncf/prms_outputs2a_ncf.py \
  /nhm/NHM-PRMS_CONUS_GF_1_1/

# verifier
/opt/conda/bin/python -u \
  /usr/local/src/onhm-verify-eval/src/prms_verifier.py \
  /nhm/NHM-PRMS_CONUS_GF_1_1/

# PRMS in restart mode

# In operational mode, end time is start date + 1 day in PRMS end_date
# datetime format.
if [ "$GRIDMET_DISABLE" != true ]; then
    END_TIME=`date --date "$yesterday -59 days" +%Y,%m,%d,00,00,00`
fi

if [ -z "$SAVE_RESTART_DATE" ]; then
    SAVE_RESTART_DATE=`date --date "$yesterday -59 days" --rfc-3339='date'`
fi

$SOURCE_DIR/prms/prms/prms \
  -set start_time $START_TIME -set end_time $END_TIME \
  -set init_vars_from_file 1 \
  -set var_init_file /nhm/NHM-PRMS_CONUS_GF_1_1/restart/$RESTART_DATE.restart \
  -set save_vars_to_file 1 \
  -set var_save_file \
       /nhm/NHM-PRMS_CONUS_GF_1_1/restart/$SAVE_RESTART_DATE.restart \
  -C /nhm/NHM-PRMS_CONUS_GF_1_1/NHM-PRMS.control
